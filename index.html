<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>FOSDEM 2026 - Talk Tracker</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Entry / Login View -->
    <div id="entryView" class="view active">
        <div class="entry-card">
            <div class="entry-logo">üáßüá™</div>
            <h1 class="entry-title" id="entryTitle">FOSDEM 2026</h1>
            <p class="entry-subtitle" id="entrySubtitle">Coordinate with your group</p>
            <form class="entry-form" id="entryForm">
                <input type="text" class="entry-input" id="groupNameInput" placeholder="Group Password / Secret" maxlength="30" required>
                <input type="text" class="entry-input" id="nicknameInput" placeholder="Your nickname" maxlength="20" required>
                <input type="number" class="entry-input hidden" id="pinInput" placeholder="Enter your 4-digit PIN" maxlength="4" minlength="4">
                <button type="submit" class="btn-primary" id="entryButton">Join Group</button>
            </form>
            <p id="entryError" class="error-message hidden"></p>
        </div>
    </div>

    <!-- Main App View -->
    <div id="mainView" class="view">
        <div class="main-area">
            <header class="app-header">
                <div class="app-title">FOSDEM 2026</div>
                <div class="user-info">
                    <span id="displayGroup">Group: -</span><br>
                    <span id="displayUser">User: -</span>
                    <button onclick="FosdemApp.logout()">Logout</button>
                </div>
            </header>

            <!-- Search Bar (Schedule view only) -->
            <div class="search-container" id="searchContainer">
                <input type="text" class="search-input" id="searchInput" placeholder="Search talks...">
            </div>

            <!-- Loading State -->
            <div class="loading hidden" id="loading">
                <div class="loading-spinner"></div>
                <div>Loading schedule...</div>
            </div>

            <!-- Schedule View -->
            <div id="scheduleView" class="content view-section">
                <div class="tracks-container" id="tracksContainer"></div>
            </div>

            <!-- My Plan View -->
            <div id="myPlanView" class="content view-section hidden">
                <div class="my-plan-header">
                    <div class="my-plan-count" id="myPlanCount">0</div>
                    <div class="my-plan-label">talks planned</div>
                </div>
                <div id="myPlanContainer"></div>
            </div>

            <!-- Friends View -->
            <div id="friendsView" class="content view-section hidden">
                <div class="friend-list" id="friendList"></div>
                <button class="clear-filter-btn hidden" id="clearFriendFilter">Show All Friends</button>
                <div id="friendTalksContainer"></div>
            </div>
        </div>

        <!-- Tab Bar Navigation -->
        <nav class="tab-bar">
            <button class="tab active" data-view="schedule">
                <span class="tab-icon">üìÖ</span>
                <span class="tab-label">Schedule</span>
            </button>
            <button class="tab" data-view="myplan">
                <span class="tab-icon">‚≠ê</span>
                <span class="tab-label">My Plan</span>
            </button>
            <button class="tab" data-view="friends">
                <span class="tab-icon">üë•</span>
                <span class="tab-label">Friends</span>
            </button>
        </nav>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>

    <!-- Application Module -->
    <script src="app.js"></script>

    <!-- View Logic -->
    <script>
        // View Management
        const views = {
            entry: document.getElementById('entryView'),
            main: document.getElementById('mainView')
        };

        const sections = {
            schedule: document.getElementById('scheduleView'),
            myplan: document.getElementById('myPlanView'),
            friends: document.getElementById('friendsView')
        };

        const tabs = document.querySelectorAll('.tab');

        function showView(viewName) {
            Object.keys(views).forEach(key => {
                views[key].classList.toggle('active', key === viewName);
            });
        }

        function showSection(sectionName) {
            Object.keys(sections).forEach(key => {
                sections[key].classList.toggle('hidden', key !== sectionName);
            });

            tabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === sectionName);
            });

            // Show/hide search bar
            document.getElementById('searchContainer').classList.toggle('hidden', sectionName !== 'schedule');

            FosdemApp.setCurrentView(sectionName);
        }

        // Tab click handlers
        tabs.forEach(tab => {
            tab.addEventListener('click', () => showSection(tab.dataset.view));
        });

        // Entry Form
        const entryForm = document.getElementById('entryForm');
        const entryError = document.getElementById('entryError');
        const entryTitle = document.getElementById('entryTitle');
        const entrySubtitle = document.getElementById('entrySubtitle');
        const pinInput = document.getElementById('pinInput');
        const entryButton = document.getElementById('entryButton');

        let pendingRegistration = null;

        entryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            entryError.classList.add('hidden');

            const nickname = document.getElementById('nicknameInput').value.trim();
            const group = document.getElementById('groupNameInput').value.trim();
            const pin = pinInput.value.trim();

            // If PIN input is visible, we're in reclaim or setup mode
            if (!pinInput.classList.contains('hidden')) {
                if (!pin || pin.length < 4) {
                    entryError.textContent = 'Please enter a 4-digit PIN';
                    entryError.classList.remove('hidden');
                    return;
                }
                try {
                    await FosdemApp.register(nickname, group, pin);
                    showMainApp();
                } catch (error) {
                    entryError.textContent = error.message || 'Incorrect PIN';
                    entryError.classList.remove('hidden');
                }
                return;
            }

            // Check if nickname already exists
            const existingUser = await FosdemApp.findUserByNickname(group, nickname);

            if (existingUser) {
                // Nickname exists - need PIN to reclaim
                entryTitle.textContent = 'Welcome back!';
                entrySubtitle.textContent = 'Enter your PIN to reclaim your identity';
                pinInput.classList.remove('hidden');
                pinInput.required = true;
                pinInput.placeholder = 'Enter your 4-digit PIN';
                pinInput.focus();
                entryButton.textContent = 'Verify & Join';
                return;
            }

            // New user - ask for PIN first, then register
            entryTitle.textContent = 'Create your identity';
            entrySubtitle.textContent = 'Choose a 4-digit PIN to protect your nickname';
            pinInput.classList.remove('hidden');
            pinInput.required = true;
            pinInput.placeholder = 'Choose a 4-digit PIN';
            pinInput.focus();
            entryButton.textContent = 'Create & Join';
        });

        function showMainApp() {
            showView('main');
            updateHeader();
        }

        function updateHeader() {
            document.getElementById('displayGroup').textContent = `Group: ${FosdemApp.groupName}`;
            document.getElementById('displayUser').textContent = `User: ${FosdemApp.nickname}`;
        }

        // Search
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                FosdemApp.setSearchQuery(e.target.value);
                renderSchedule();
            }, 300);
        });

        // ========== RENDER FUNCTIONS ==========

        function renderSchedule() {
            const container = document.getElementById('tracksContainer');
            const tracks = FosdemApp.getFilteredTalks();

            if (Object.keys(tracks).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">No talks found</div>
                        <div class="empty-state-sub">Try a different search term</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = Object.keys(tracks).map(trackSlug => {
                const track = tracks[trackSlug];
                return `
                    <div class="track">
                        <div class="track-header" onclick="toggleTrack('${trackSlug}')">
                            <div class="track-title">${track.name}</div>
                            <button class="track-toggle">
                                <span class="track-collapse-icon collapsed" id="collapse-${trackSlug}">‚ñº</span>
                            </button>
                        </div>
                        <div class="talks-list collapsed" id="talks-${trackSlug}">
                            ${track.talks.map(talk => renderTalkCard(talk)).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Update button states for all talks
            Object.keys(tracks).forEach(trackSlug => {
                tracks[trackSlug].talks.forEach(talk => {
                    updateTalkButtonState(talk.slug);
                    updateAttendanceDisplay(talk.slug);
                });
            });
        }

        function renderTalkCard(talk) {
            const isGoing = FosdemApp.isUserAttending(talk.slug);
            const metaParts = [];
            if (talk.date) metaParts.push(`<span>${talk.date}</span>`);
            if (talk.start) metaParts.push(`<span>${talk.start}</span>`);
            if (talk.duration) metaParts.push(`<span>${talk.duration}</span>`);
            if (talk.room) metaParts.push(`<span>${talk.room}</span>`);

            return `
                <div class="talk" id="talk-${talk.slug}">
                    <div>
                        <div class="talk-header">
                            <div class="talk-title">${talk.title}</div>
                        </div>
                        <div class="talk-meta">${metaParts.join('')}</div>
                    </div>
                    <div class="talk-actions">
                        <button class="action-btn going ${isGoing ? 'active' : ''}"
                                onclick="toggleGoing('${talk.slug}')"
                                id="going-btn-${talk.slug}">
                            <span>${isGoing ? '‚úì' : '‚ûï'}</span> Going
                        </button>
                    </div>
                    <div class="attendance-list" id="attendance-${talk.slug}"></div>
                </div>
            `;
        }

        function updateTalkButtonState(talkSlug) {
            const btn = document.getElementById(`going-btn-${talkSlug}`);
            if (btn) {
                const isGoing = FosdemApp.isUserAttending(talkSlug);
                btn.classList.toggle('active', isGoing);
                btn.querySelector('span').textContent = isGoing ? '‚úì' : '‚ûï';
            }
        }

        function toggleTrack(trackSlug) {
            const talksList = document.getElementById(`talks-${trackSlug}`);
            const collapseIcon = document.getElementById(`collapse-${trackSlug}`);

            talksList.classList.toggle('collapsed');
            collapseIcon.classList.toggle('collapsed');
        }

        async function toggleGoing(talkSlug) {
            try {
                await FosdemApp.toggleAttendance(talkSlug, 'going');
                updateTalkButtonState(talkSlug);
                updateAttendanceDisplay(talkSlug);
                updateMyPlanCount();
            } catch (error) {
                console.error('Error toggling attendance:', error);
            }
        }

        async function updateAttendanceDisplay(talkSlug) {
            const container = document.getElementById(`attendance-${talkSlug}`);
            if (!container) return;

            const attendees = await FosdemApp.getAttendees(talkSlug, 'going');

            if (attendees.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <span class="attendance-label">Going:</span>
                <div class="attendance-tags">
                    ${attendees.map(a => `<span class="attendance-tag">${a.nickname}</span>`).join('')}
                </div>
            `;
        }

        function updateMyPlanCount() {
            const count = FosdemApp.getMyTalks().length;
            document.getElementById('myPlanCount').textContent = count;
        }

        function renderMyPlan() {
            const container = document.getElementById('myPlanContainer');
            const talks = FosdemApp.getMyTalks();

            updateMyPlanCount();

            if (talks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚≠ê</div>
                        <div class="empty-state-text">No talks planned yet</div>
                        <div class="empty-state-sub">Browse the schedule and mark talks as "Going"</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="track">
                    <div class="talks-list">
                        ${talks.map(talk => renderTalkCard(talk)).join('')}
                    </div>
                </div>
            `;
        }

        function renderFriends() {
            const container = document.getElementById('friendList');
            const friends = FosdemApp.getOtherUsers();

            if (friends.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <div class="empty-state-text">No other friends in this group</div>
                        <div class="empty-state-sub">Share the group secret to invite others!</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = friends.map(friend => {
                const talkCount = FosdemApp.getTalksForUser(friend.uid).length;
                const initial = friend.nickname.charAt(0).toUpperCase();

                return `
                    <div class="friend-item" onclick="showFriendTalks('${friend.uid}', '${friend.nickname}')">
                        <div class="friend-info">
                            <div class="friend-avatar">${initial}</div>
                            <div class="friend-name">${friend.nickname}</div>
                        </div>
                        <div class="friend-talk-count">${talkCount}</div>
                    </div>
                `;
            }).join('');
        }

        function showFriendTalks(uid, nickname) {
            FosdemApp.setFilter('user', uid);
            const talks = FosdemApp.getTalksForUser(uid);
            const container = document.getElementById('friendTalksContainer');

            document.getElementById('clearFriendFilter').classList.remove('hidden');
            document.querySelectorAll('.friend-item').forEach(item => item.classList.remove('active'));

            container.innerHTML = `
                <div class="my-plan-header">
                    <div class="my-plan-count">${nickname}</div>
                    <div class="my-plan-label">${talks.length} talks planned</div>
                </div>
                <div class="track">
                    <div class="talks-list">
                        ${talks.map(talk => renderTalkCard(talk)).join('')}
                    </div>
                </div>
            `;
        }

        document.getElementById('clearFriendFilter').addEventListener('click', () => {
            FosdemApp.clearFilter();
            document.getElementById('clearFriendFilter').classList.add('hidden');
            document.getElementById('friendTalksContainer').innerHTML = '';
            document.querySelectorAll('.friend-item').forEach(item => item.classList.remove('active'));
            renderFriends();
        });

        // ========== APP INITIALIZATION ==========

        // Register app callbacks
        FosdemApp.on('onScheduleLoaded', () => {
            document.getElementById('loading').classList.add('hidden');
            renderSchedule();
            renderMyPlan();
            renderFriends();
        });

        FosdemApp.on('onAttendanceUpdate', () => {
            if (FosdemApp.currentView === 'schedule') {
                renderSchedule();
            } else if (FosdemApp.currentView === 'myplan') {
                renderMyPlan();
            } else if (FosdemApp.currentView === 'friends') {
                renderFriends();
            }
            updateMyPlanCount();
        });

        FosdemApp.on('onUsersUpdate', () => {
            renderFriends();
        });

        FosdemApp.on('onViewChange', (view) => {
            if (view === 'schedule') {
                renderSchedule();
            } else if (view === 'myplan') {
                renderMyPlan();
            } else if (view === 'friends') {
                renderFriends();
            }
        });

        FosdemApp.on('onAuthStateChange', async (user) => {
            if (user) {
                const savedGroup = FosdemApp.checkSavedSession();
                if (savedGroup) {
                    const session = await FosdemApp.restoreSession();
                    if (session) {
                        showMainApp();
                    }
                }
            }
        });

        // Initialize
        (async function init() {
            document.getElementById('loading').classList.remove('hidden');

            try {
                await FosdemApp.loadSchedule();
                document.getElementById('loading').classList.add('hidden');
            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-text">Error loading schedule</div>
                    </div>
                `;
            }
        })();
    </script>
</body>
</html>
